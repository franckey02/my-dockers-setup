name: Build MCPELauncher Ubuntu

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-ubuntu:
    # Se utiliza 22.04 por su mayor compatibilidad con librerías i386 (32-bit)
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Configure i386 Architecture
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update

    - name: Install Essential Build Tools
      run: |
        sudo apt-get install -y \
          cmake gcc-multilib g++-multilib \
          zlib1g-dev:i386 libx11-dev:i386 libzip-dev:i386 \
          libpng-dev:i386 libcurl4-openssl-dev:i386 libssl-dev:i386 \
          libgles2-mesa-dev:i386 libudev-dev:i386 libevdev-dev:i386 \
          libegl1-mesa-dev:i386

    - name: Install CEF & First Time Setup Dependencies
      run: |
        # Intentamos instalar las dependencias de Xbox Live y Protobuf
        # Nota: libgconf2-4 y libgtkglext1 pueden ser problemáticas en versiones nuevas,
        # se instalan por separado para no romper el flujo principal si fallan.
        sudo apt-get install -y \
          libgtk2.0-0:i386 libasound2:i386 libnss3:i386 \
          libxss1:i386 libxtst6:i386 libudev1:i386 \
          protobuf-compiler libprotobuf-dev:i386 || true
        
        sudo apt-get install -y libgtkglext1:i386 libgconf2-4:i386 || echo "Librerías legacy opcionales no encontradas"

    - name: Run Setup Scripts
      run: |
        chmod +x download_icon.sh setup_bin_libs.sh
        ./download_icon.sh
        ./setup_bin_libs.sh

    - name: Compile
      run: |
        mkdir build
        cd build
        cmake ..
        make -j$(nproc)

    - name: Upload Binary
      uses: actions/upload-artifact@v4
      with:
        name: mcpelauncher-ubuntu-i386
        path: |
          build/mcpelauncher
          build/*.so
