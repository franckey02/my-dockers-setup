name: Build MCPELauncher

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    strategy:
      matrix:
        # Forzamos ubuntu-22.04 para asegurar disponibilidad de paquetes i386 antiguos
        os: [ubuntu-22.04, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies (Ubuntu 22.04)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        # Instalamos las dependencias esenciales primero, omitiendo las obsoletas si fallan
        sudo apt-get install -y \
          cmake gcc-multilib g++-multilib \
          zlib1g-dev:i386 libx11-dev:i386 libpng-dev:i386 \
          libcurl4-openssl-dev:i386 libssl-dev:i386 \
          libgles2-mesa-dev:i386 libudev-dev:i386 libevdev-dev:i386 \
          libasound2:i386 libnss3:i386 libxss1:i386 libxtst6:i386 \
          libudev1:i386 protobuf-compiler libprotobuf-dev:i386 \
          libegl1-mesa-dev:i386
        
        # Intentar instalar las librerías problemáticas por separado (CEF/Xbox Live)
        # Si fallan, la compilación base podría seguir adelante
        sudo apt-get install -y libzip-dev:i386 libgtk2.0-0:i386 || echo "Algunas librerías de UI fallaron"

    - name: Install Dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: brew install cmake

    - name: Prepare Scripts
      run: |
        chmod +x download_icon.sh setup_bin_libs.sh
        ./download_icon.sh
        ./setup_bin_libs.sh

    - name: Configure and Build
      run: |
        mkdir build
        cd build
        # En Linux, forzamos flags de 32 bits si es necesario, 
        # aunque el launcher suele detectarlo por las dependencias instaladas.
        cmake ..
        if [ "${{ matrix.os }}" = "ubuntu-22.04" ]; then
          make -j$(nproc)
        else
          make -j$(sysctl -n hw.ncpu)
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mcpelauncher-${{ matrix.os }}
        path: build/mcpelauncher
